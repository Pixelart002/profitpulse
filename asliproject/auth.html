<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kyro AI Auth</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/motion-tailwind/motion-tailwind.css">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-white rounded-lg py-5">
  <div class="container flex flex-col mx-auto bg-white rounded-lg pt-12 my-5">
    <div class="flex justify-center w-full h-full my-auto xl:gap-14 lg:justify-normal md:gap-5 draggable">
      <div class="flex items-center justify-center w-full lg:p-12">
        <div class="flex items-center xl:p-10">
          <form id="authForm" class="flex flex-col w-full h-full pb-6 text-center bg-white rounded-3xl">
            <h3 id="formTitle" class="mb-3 text-4xl font-extrabold text-dark-grey-900">Sign In</h3>
            <p id="formSubtitle" class="mb-4 text-grey-700">Enter your email and password</p>
            
            <!-- Google Sign-in Button -->
            <div id="gSignIn" class="flex items-center justify-center w-full py-4 mb-6 text-sm font-medium transition duration-300 rounded-2xl text-grey-900 bg-grey-300 hover:bg-grey-400 focus:ring-4 focus:ring-grey-300 cursor-pointer">
              <img class="h-5 mr-2" src="https://raw.githubusercontent.com/Loopple/loopple-public-assets/main/motion-tailwind/img/logos/logo-google.png" alt="">
              <span>Sign in with Google</span>
            </div>

            <div class="flex items-center mb-3">
              <hr class="h-0 border-b border-solid border-grey-500 grow">
              <p class="mx-4 text-grey-600">or</p>
              <hr class="h-0 border-b border-solid border-grey-500 grow">
            </div>

            <!-- Email Input -->
            <label for="email" class="mb-2 text-sm text-start text-grey-900">Email*</label>
            <input id="email" type="email" placeholder="mail@example.com" 
              class="flex items-center w-full px-5 py-4 mr-2 text-sm font-medium outline-none focus:bg-grey-400 mb-7 placeholder:text-grey-700 bg-grey-200 text-dark-grey-900 rounded-2xl" required>

            <!-- Password Input -->
            <label for="password" class="mb-2 text-sm text-start text-grey-900">Password*</label>
            <input id="password" type="password" placeholder="Enter password" 
              class="flex items-center w-full px-5 py-4 mb-5 mr-2 text-sm font-medium outline-none focus:bg-grey-400 placeholder:text-grey-700 bg-grey-200 text-dark-grey-900 rounded-2xl" required>

            <!-- Sign Up Fields (Hidden by default) -->
            <div id="signupFields" class="hidden">
              <label for="fullname" class="mb-2 text-sm text-start text-grey-900">Full Name*</label>
              <input id="fullname" type="text" placeholder="Your full name" 
                class="flex items-center w-full px-5 py-4 mb-5 mr-2 text-sm font-medium outline-none focus:bg-grey-400 placeholder:text-grey-700 bg-grey-200 text-dark-grey-900 rounded-2xl">

              <label for="role" class="mb-2 text-sm text-start text-grey-900">Role*</label>
              <select id="role" 
                class="flex items-center w-full px-5 py-4 mb-5 mr-2 text-sm font-medium outline-none focus:bg-grey-400 placeholder:text-grey-700 bg-grey-200 text-dark-grey-900 rounded-2xl">
                <option value="">Select Role</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>

            <!-- Remember Me & Forgot Password -->
            <div class="flex flex-row justify-between mb-8">
              <label class="relative inline-flex items-center mr-3 cursor-pointer select-none">
                <input type="checkbox" checked value="" class="sr-only peer">
                <div class="w-5 h-5 bg-white border-2 rounded-sm border-grey-500 peer peer-checked:border-0 peer-checked:bg-purple-blue-500">
                  <img src="https://raw.githubusercontent.com/Loopple/loopple-public-assets/main/motion-tailwind/img/icons/check.png" alt="tick">
                </div>
                <span class="ml-3 text-sm font-normal text-grey-900">Keep me logged in</span>
              </label>
              <a href="#" class="mr-4 text-sm font-medium text-purple-blue-500">Forgot password?</a>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="authButton" 
              class="w-full px-6 py-5 mb-5 text-sm font-bold leading-none text-white transition duration-300 md:w-96 rounded-2xl hover:bg-purple-blue-600 focus:ring-4 focus:ring-purple-blue-100 bg-purple-blue-500">
              Sign In
            </button>

            <!-- Toggle Link -->
            <p class="text-sm leading-relaxed text-grey-900">
              <span id="toggleText">Not registered yet?</span> 
              <a id="toggleLink" href="javascript:void(0)" class="font-bold text-grey-700">Create an Account</a>
            </p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://wqxlakambzrebifqszbo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeGxha2FtYnpyZWJpZnFzemJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzMjcsImV4cCI6MjA1OTc2NjMyN30.kIEpEt84s5sRAPmaN7Vb2oQCnXIHnKVxPFXD5gDqNuQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isSignUp = false;

    // Toggle between Sign In/Sign Up
    document.getElementById('toggleLink').addEventListener('click', () => {
      isSignUp = !isSignUp;
      document.getElementById('formTitle').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('formSubtitle').textContent = isSignUp 
        ? 'Create your account' 
        : 'Enter your email and password';
      document.getElementById('signupFields').classList.toggle('hidden', !isSignUp);
      document.getElementById('authButton').textContent = isSignUp ? 'Sign Up' : 'Sign In';
      document.getElementById('toggleText').textContent = isSignUp 
        ? 'Already have an account?' 
        : 'Not registered yet?';
      document.getElementById('toggleLink').textContent = isSignUp ? 'Login' : 'Create an Account';
    });

    // Form Submission
    document.getElementById('authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const fullname = document.getElementById('fullname')?.value;
      const role = document.getElementById('role')?.value;

      try {
        if(isSignUp) {
          // Sign Up Logic
          if(!fullname || !role) throw new Error('All fields are required');

          const { data: { user }, error: authError } = await supabase.auth.signUp({
            email,
            password,
            options: { data: { fullname, role } }
          });

          if(authError) throw authError;

          // Insert into public.users table
          const { error: dbError } = await supabase.from('users').insert({
            id: user.id,
            email,
            fullname,
            role
          });

          if(dbError) throw dbError;

          alert('Verification email sent! Please check your inbox.');
        } else {
          // Sign In Logic
          const { data: { user }, error } = await supabase.auth.signInWithPassword({
            email,
            password
          });

          if(error) throw error;
          if(!user.email_confirmed_at) {
            await supabase.auth.signOut();
            throw new Error('Please verify your email first');
          }

          sessionStorage.setItem('user', JSON.stringify(user));
          window.location.href = '/dashboard';
        }
      } catch (error) {
        alert(error.message);
        console.error(error);
      }
    });

    // Google Sign-In
    google.accounts.id.initialize({
      client_id: '1047818163471-vdijksv0ta6f0u1msu2e8gvd792097fi.apps.googleusercontent.com',
      callback: async (response) => {
        const { data: { user }, error } = await supabase.auth.signInWithIdToken({
          provider: 'google',
          token: response.credential
        });

        if(error) {
          alert('Google login failed: ' + error.message);
          return;
        }

        // Check if user exists in public.users
        const { data: existingUser } = await supabase
          .from('users')
          .select('id')
          .eq('email', user.email)
          .single();

        if(!existingUser) {
          // Create new user profile
          await supabase.from('users').insert({
            id: user.id,
            email: user.email,
            fullname: user.user_metadata.full_name || 'Google User',
            role: 'user'
          });
        }

        sessionStorage.setItem('user', JSON.stringify(user));
        window.location.href = '/dashboard';
      }
    });

    // Attach Google Sign-In to button
    document.getElementById('gSignIn').addEventListener('click', () => {
      google.accounts.id.prompt();
    });
  </script>
</body>
</html>