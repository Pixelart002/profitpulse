<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kyro AI Auth</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/motion-tailwind/motion-tailwind.css">
  <style>
    .hidden { display: none; }
    .password-toggle { cursor: pointer; right: 15px; top: 50%; transform: translateY(-50%); }
  </style>
</head>

<body class="bg-white min-h-screen flex items-center justify-center">
  <div class="container max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">üîí Kyro AI Authentication</h1>
    </div>

    <form id="auth-form" class="space-y-6">
      <!-- Mode Toggle -->
      <div class="flex justify-center gap-4 mb-6">
        <button type="button" id="loginTab" class="tab-btn active">Sign In</button>
        <button type="button" id="signupTab" class="tab-btn">Sign Up</button>
      </div>

      <!-- Google SignIn -->
      <div id="gSignInDiv" class="flex items-center justify-center w-full py-3 px-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
        <img src="https://img.icons8.com/color/48/000000/google-logo.png" class="w-6 h-6 mr-2" alt="Google logo">
        <span>Continue with Google</span>
      </div>

      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white text-gray-500">or continue with email</span>
        </div>
      </div>

      <!-- Email Input -->
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
        <input id="email" name="email" type="email" autocomplete="email" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Password Input -->
      <div class="relative">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <span class="password-toggle" onclick="togglePasswordVisibility()">üëÅÔ∏è</span>
      </div>

      <!-- Additional SignUp Fields -->
      <div id="signupFields" class="hidden space-y-6">
        <div>
          <label for="fullname" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
          <input id="fullname" name="fullname" type="text" 
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
          <select id="role" name="role" 
            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">Select Role</option>
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
      </div>

      <!-- Remember Me & Forgot Password -->
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <input id="remember-me" name="remember-me" type="checkbox" 
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
          <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
        </div>
        <a href="#" class="text-sm text-blue-600 hover:text-blue-500">Forgot password?</a>
      </div>

      <!-- Submit Button -->
      <button type="submit" id="authButton" 
        class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Sign In
      </button>
    </form>
  </div>

  <script>
    const SUPABASE_URL = 'https://wqxlakambzrebifqszbo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeGxha2FtYnpyZWJpZnFzemJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxOTAzMjcsImV4cCI6MjA1OTc2NjMyN30.kIEpEt84s5sRAPmaN7Vb2oQCnXIHnKVxPFXD5gDqNuQ';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentMode = 'login';

    // UI Elements
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const signupFields = document.getElementById('signupFields');
    const authButton = document.getElementById('authButton');

    // Tab Switching
    [loginTab, signupTab].forEach(tab => {
      tab.addEventListener('click', () => {
        currentMode = tab.id === 'loginTab' ? 'login' : 'signup';
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        signupFields.classList.toggle('hidden', currentMode === 'login');
        authButton.textContent = currentMode === 'login' ? 'Sign In' : 'Sign Up';
      });
    });

    // Form Submission
    document.getElementById('auth-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const fullname = document.getElementById('fullname')?.value;
      const role = document.getElementById('role')?.value;

      try {
        if(currentMode === 'login') {
          // Login Logic
          const { data: { user }, error } = await supabase.auth.signInWithPassword({ email, password });
          
          if(error) throw error;
          if(!user.email_confirmed_at) {
            await supabase.auth.signOut();
            throw new Error('Please verify your email before logging in.');
          }

          sessionStorage.setItem('user', JSON.stringify(user));
          window.location.href = '/dashboard';
        } else {
          // Signup Logic
          if(!fullname || !role) throw new Error('All fields are required.');
          
          // Check existing user
          const { data: existingUser } = await supabase
            .from('users')
            .select('email')
            .eq('email', email)
            .single();

          if(existingUser) throw new Error('Email already registered. Please login.');

          // Create user
          const { data: { user }, error } = await supabase.auth.signUp({
            email,
            password,
            options: { data: { fullname, role } }
          });

          if(error) throw error;

          // Insert public profile
          const { error: insertError } = await supabase.from('users').insert({
            id: user.id,
            email,
            fullname,
            role
          });

          if(insertError) throw insertError;

          alert('Verification email sent! Please check your inbox.');
          loginTab.click();
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
        console.error(error);
      }
    });

    // Google Auth
    google.accounts.id.initialize({
      client_id: '1047818163471-vdijksv0ta6f0u1msu2e8gvd792097fi.apps.googleusercontent.com',
      callback: async response => {
        const { data: { user }, error } = await supabase.auth.signInWithIdToken({
          provider: 'google',
          token: response.credential
        });

        if(error) return alert(`Google login failed: ${error.message}`);

        // Check/Create profile
        const { data: existingProfile } = await supabase
          .from('users')
          .select('id')
          .eq('email', user.email)
          .single();

        if(!existingProfile) {
          await supabase.from('users').insert({
            id: user.id,
            email: user.email,
            fullname: user.user_metadata.name,
            role: 'user'
          });
        }

        sessionStorage.setItem('user', JSON.stringify(user));
        window.location.href = '/dashboard';
      }
    });

    // Helper Functions
    function togglePasswordVisibility() {
      const passwordField = document.getElementById('password');
      passwordField.type = passwordField.type === 'password' ? 'text' : 'password';
    }
  </script>
</body>

</html>